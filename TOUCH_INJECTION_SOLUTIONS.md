# TrollTouch 触摸注入解决方案

## 问题诊断

通过日志分析确认：
- ✅ HID 事件成功创建并发送到系统
- ✅ 坐标计算正确 (0.0-1.0 归一化范围)
- ✅ 后台保活机制正常运行
- ❌ **TikTok 未响应触摸事件**

**根本原因**：iOS 15.8.5 的安全机制阻止后台应用通过 `IOHIDEventSystemClientDispatchEvent` 向前台应用注入触摸事件。

## 解决方案

### 方案 1：透明覆盖窗口（已实现）✅

**原理**：创建一个透明的全屏窗口覆盖在所有应用之上，使 TrollTouch 保持前台状态，同时允许触摸事件穿透到下层应用。

**实现细节**：
- 窗口层级：`UIWindowLevelAlert + 1`（最高层级）
- 透明度：`alpha = 0.01`（几乎不可见）
- 触摸穿透：`userInteractionEnabled = NO`
- 状态指示器：右上角显示 🤖 图标

**优点**：
- 无需用户额外授权
- 兼容性好
- 实现简单

**缺点**：
- 窗口始终存在（虽然透明）
- 可能影响某些系统手势

**使用方法**：
启动自动化后，会自动创建透明覆盖窗口。你会在屏幕右上角看到一个小的 🤖 图标，表示 TrollTouch 处于活动状态。

### 方案 2：辅助功能 API（备选）

**原理**：使用 iOS 的辅助功能框架（Accessibility）来模拟触摸事件。

**要求**：
- 用户需要在 **设置 > 辅助功能 > 触控 > 辅助触控** 中授予 TrollTouch 权限
- 需要重新编译应用以包含辅助功能权限

**优点**：
- 官方支持的 API
- 更稳定可靠
- 不需要透明窗口

**缺点**：
- 需要用户手动授权
- 权限请求流程复杂

**状态**：暂未实现，如需要可以添加。

## 测试建议

1. **重新编译并安装**最新版本
2. **启动自动化**，观察右上角是否出现 🤖 图标
3. **切换到 TikTok**，观察触摸事件是否生效
4. **检查日志**：`/var/mobile/Media/Downloads/TrollTouch_Logs/app.log`

## 预期行为

启动自动化后：
- 通知显示："自动化服务已启动 (前台模式)"
- 右上角出现绿色 🤖 图标
- 切换到 TikTok 后，触摸事件应该能够正常工作
- 日志中会显示：`[系统] 透明覆盖窗口已创建`

## 故障排查

如果触摸仍然无效：
1. 确认 🤖 图标是否可见
2. 检查日志中是否有 `Dispatching type=1 mask=0x13` 等输出
3. 尝试重启设备后再次测试
4. 如果方案1不行，可以尝试实现方案2（辅助功能API）

## 技术细节

### 为什么后台注入失败？

iOS 的安全架构包含多层保护：
1. **进程隔离**：每个应用运行在独立的沙盒中
2. **事件路由**：触摸事件只能发送到当前前台应用
3. **权限检查**：即使有私有权限，系统也会验证事件来源

`IOHIDEventSystemClientDispatchEvent` 在后台调用时，系统会检测到调用者不是前台应用，直接丢弃事件。

### 透明窗口如何解决？

通过创建一个高层级的透明窗口：
1. TrollTouch 被系统识别为"前台应用"
2. HID 事件可以正常分发
3. `userInteractionEnabled = NO` 确保窗口不拦截触摸
4. 触摸事件穿透到下层的 TikTok

这是一个合法的"技巧"，利用了 iOS 窗口系统的特性。
