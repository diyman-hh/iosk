# TrollTouch 最终解决方案

## 问题总结

经过多次尝试，我们发现 iOS 15.8.5 的核心限制：
1. **后台应用无法向前台应用注入触摸事件**（即使使用 IOHIDEventSystemClient）
2. **应用窗口无法覆盖其他应用**（即使使用最高 windowLevel）

这些是 iOS 的基本安全机制，无法通过 TrollStore 的私有权限绕过。

## 最终方案：辅助功能 API + 画中画模式

### 方案概述

**组合方案 B + D**：
1. **辅助功能 API**：使用官方的 Accessibility 框架模拟触摸
2. **画中画小窗口**：TrollTouch 以小窗口形式保持在屏幕上，不遮挡 TikTok 内容

### 实现步骤

#### 第一步：添加辅助功能权限

在 `Info.plist` 中添加：
```xml
<key>NSAccessibilityUsageDescription</key>
<string>TrollTouch 需要辅助功能权限来自动化 TikTok 操作</string>
```

#### 第二步：实现辅助功能触摸注入

使用 `UIAccessibility` 和私有 API `AXUIElementPerformAction` 来模拟触摸。

#### 第三步：创建画中画小窗口

- 小窗口尺寸：60x100 像素
- 位置：屏幕右下角
- 半透明背景
- 显示运行状态和简单控制

### 优势

1. ✅ **官方支持**：辅助功能 API 是 Apple 官方提供的
2. ✅ **用户可控**：用户可以在设置中管理权限
3. ✅ **不遮挡内容**：小窗口不影响 TikTok 使用
4. ✅ **可视化反馈**：用户可以看到自动化状态

### 限制

1. ⚠️ **需要用户授权**：首次使用需要在"设置 > 辅助功能"中授予权限
2. ⚠️ **小窗口可见**：虽然很小，但仍然可见

### 授权流程

1. 安装 TrollTouch
2. 启动应用
3. 应用会提示需要辅助功能权限
4. 用户前往：**设置 > 辅助功能 > 触控 > 辅助触控**
5. 找到 TrollTouch 并启用
6. 返回应用，开始自动化

## 备选方案（如果方案 B+D 不可行）

### 方案 E：使用 `backboardd` 私有 API（高级）

如果辅助功能 API 也无法工作，可以尝试直接与 `backboardd` 守护进程通信：

```objectivec
// 需要研究 backboardd 的 Mach 端口通信协议
// 这需要逆向工程和更深入的系统知识
```

### 方案 F：完全前台模式

TrollTouch 保持全屏前台，使用透明背景，用户通过 TrollTouch 的透明层看到 TikTok。

## 下一步行动

我将立即实现方案 B + D：
1. 移除当前的透明覆盖窗口逻辑
2. 实现辅助功能触摸注入
3. 创建画中画小窗口
4. 添加权限请求和引导流程
