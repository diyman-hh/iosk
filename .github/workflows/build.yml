name: Build TrollTouch IPA

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          xcodegen generate
          echo "‚úÖ Xcode project generated from project.yml"

      - name: List Generated Project Structure
        run: |
          ls -la
          if [ -f "TrollTouch.xcodeproj/project.pbxproj" ]; then
            echo "‚úÖ Xcode project exists"
          else
            echo "‚ùå Xcode project not found"
            exit 1
          fi

      - name: Build with xcodebuild
        run: |
          echo "üî® Building TrollTouch with xcodebuild..."
          xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0 \
                     | xcpretty || xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0
          echo "‚úÖ Build completed"

      - name: Copy XCTest Bundle to PlugIns
        run: |
          echo "üì¶ Manually copying XCTest bundle to PlugIns directory..."
          
          # Find the built app and test bundle
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          TEST_BUNDLE_PATH=$(find ./build -name "TrollTouchUITests.xctest" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå TrollTouch.app not found"
            exit 1
          fi
          
          if [ -z "$TEST_BUNDLE_PATH" ]; then
            echo "‚ùå TrollTouchUITests.xctest not found"
            exit 1
          fi
          
          echo "App path: $APP_PATH"
          echo "Test bundle path: $TEST_BUNDLE_PATH"
          
          # Create PlugIns directory
          mkdir -p "$APP_PATH/PlugIns"
          
          # Copy test bundle
          cp -R "$TEST_BUNDLE_PATH" "$APP_PATH/PlugIns/"
          
          echo "‚úÖ XCTest bundle copied to PlugIns directory"
          ls -la "$APP_PATH/PlugIns/"

      - name: Verify Build Output
        run: |
          echo "üì¶ Checking build output..."
          find ./build -name "TrollTouch.app" -type d
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "‚ùå TrollTouch.app not found in build output"
            exit 1
          fi
          echo "‚úÖ App found at: $APP_PATH"
          
          # È™åËØÅÊµãËØïbundleÊòØÂê¶Â≠òÂú®
          if [ -d "$APP_PATH/PlugIns/TrollTouchUITests.xctest" ]; then
            echo "‚úÖ XCTest bundle found in app"
          else
            echo "‚ùå XCTest bundle not found"
            exit 1
          fi
          
          # Ê£ÄÊü•XCTestÊ°ÜÊû∂ÈìæÊé•
          echo "üîç Checking XCTest framework linkage..."
          otool -L "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" || true

      - name: Install ldid for Signing
        run: brew install ldid

      - name: Sign Binaries with ldid
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "üîè Signing binaries with ldid..."
          
          # Á≠æÂêç‰∏ªÂ∫îÁî®ÂèØÊâßË°åÊñá‰ª∂
          ldid -S "$APP_PATH/TrollTouch"
          echo "‚úÖ Signed main app"
          
          # Á≠æÂêçÊµãËØïbundle
          ldid -S "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests"
          echo "‚úÖ Signed XCTest bundle"

      - name: Package IPA
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "üì¶ Packaging IPA..."
          
          # ÂàõÂª∫PayloadÁõÆÂΩï
          mkdir -p Payload
          
          # Â§çÂà∂appÂà∞Payload
          cp -R "$APP_PATH" Payload/
          
          # Á°Æ‰øùInfo.plistÊ≠£Á°Æ
          cp TrollTouch/Info.plist Payload/TrollTouch.app/Info.plist
          
          # ÊâìÂåÖ‰∏∫IPA
          zip -r TrollTouch.ipa Payload
          
          echo "‚úÖ IPA created successfully"
          ls -lh TrollTouch.ipa

      - name: Verify IPA Contents
        run: |
          echo "üîç Verifying IPA structure..."
          unzip -l TrollTouch.ipa
          
          echo ""
          echo "üìù Checking for XCTest bundle..."
          if unzip -l TrollTouch.ipa | grep -q "TrollTouchUITests.xctest"; then
            echo "‚úÖ XCTest bundle is included in IPA"
          else
            echo "‚ùå XCTest bundle missing from IPA"
            exit 1
          fi

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollTouch_IPA
          path: TrollTouch.ipa
          retention-days: 30

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build_Logs
          path: |
            ./build/Logs
          retention-days: 7

