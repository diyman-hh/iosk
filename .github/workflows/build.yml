name: Build TrollTouch IPA

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode Project
        run: |
          xcodegen generate
          echo "âœ… Xcode project generated from project.yml"

      - name: List Generated Project Structure
        run: |
          ls -la
          if [ -f "TrollTouch.xcodeproj/project.pbxproj" ]; then
            echo "âœ… Xcode project exists"
          else
            echo "âŒ Xcode project not found"
            exit 1
          fi

      - name: Build with xcodebuild
        run: |
          echo "ğŸ”¨ Building TrollTouch with xcodebuild..."
          xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0 \
                     | xcpretty || xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0
          echo "âœ… Build completed"

      - name: Verify Build Output
        run: |
          echo "ğŸ“¦ Checking build output..."
          find ./build -name "TrollTouch.app" -type d
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ TrollTouch.app not found in build output"
            exit 1
          fi
          echo "âœ… App found at: $APP_PATH"
          
          # éªŒè¯æµ‹è¯•bundleæ˜¯å¦å­˜åœ¨
          if [ -d "$APP_PATH/PlugIns/TrollTouchUITests.xctest" ]; then
            echo "âœ… XCTest bundle found in app"
          else
            echo "âŒ XCTest bundle not found"
            exit 1
          fi
          
          # æ£€æŸ¥XCTestæ¡†æ¶é“¾æ¥
          echo "ğŸ” Checking XCTest framework linkage..."
          otool -L "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" || true

      - name: Install ldid for Signing
        run: brew install ldid

      - name: Sign Binaries with ldid
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "ğŸ” Signing binaries with ldid..."
          
          # ç­¾åä¸»åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶
          ldid -S "$APP_PATH/TrollTouch"
          echo "âœ… Signed main app"
          
          # ç­¾åæµ‹è¯•bundle
          ldid -S "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests"
          echo "âœ… Signed XCTest bundle"

      - name: Package IPA
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "ğŸ“¦ Packaging IPA..."
          
          # åˆ›å»ºPayloadç›®å½•
          mkdir -p Payload
          
          # å¤åˆ¶appåˆ°Payload
          cp -R "$APP_PATH" Payload/
          
          # ç¡®ä¿Info.plistæ­£ç¡®
          cp TrollTouch/Info.plist Payload/TrollTouch.app/Info.plist
          
          # æ‰“åŒ…ä¸ºIPA
          zip -r TrollTouch.ipa Payload
          
          echo "âœ… IPA created successfully"
          ls -lh TrollTouch.ipa

      - name: Verify IPA Contents
        run: |
          echo "ğŸ” Verifying IPA structure..."
          unzip -l TrollTouch.ipa
          
          echo ""
          echo "ğŸ“ Checking for XCTest bundle..."
          if unzip -l TrollTouch.ipa | grep -q "TrollTouchUITests.xctest"; then
            echo "âœ… XCTest bundle is included in IPA"
          else
            echo "âŒ XCTest bundle missing from IPA"
            exit 1
          fi

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollTouch_IPA
          path: TrollTouch.ipa
          retention-days: 30

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build_Logs
          path: |
            ./build/Logs
          retention-days: 7

