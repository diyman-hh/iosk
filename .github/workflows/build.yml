name: Build TrollTouch IPA

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Auto Increment Version
        run: |
          # Get current version from Info.plist
          CURRENT_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" TrollTouch/Info.plist)
          echo "Current version: $CURRENT_VERSION"
          
          # Increment version (simple integer increment)
          NEW_VERSION=$((CURRENT_VERSION + 1))
          echo "New version: $NEW_VERSION"
          
          # Update Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_VERSION" TrollTouch/Info.plist
          
          echo "âœ… Version bumped from $CURRENT_VERSION to $NEW_VERSION"

      - name: Generate Xcode Project
        run: |
          xcodegen generate
          echo "âœ… Xcode project generated from project.yml"

      - name: List Generated Project Structure
        run: |
          ls -la
          if [ -f "TrollTouch.xcodeproj/project.pbxproj" ]; then
            echo "âœ… Xcode project exists"
          else
            echo "âŒ Xcode project not found"
            exit 1
          fi

      - name: Build with xcodebuild
        run: |
          echo "ğŸ”¨ Building TrollTouch with xcodebuild..."
          set -o pipefail
          xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0 \
                     2>&1 | tee build.log
          
          echo "âœ… Build completed"
          
          # Show what was actually built
          echo "ğŸ“¦ Build products:"
          find ./build -type f -name "*.app" -o -name "*.xctest" -o -name "TrollTouch" | head -20

      - name: Copy XCTest Bundle to PlugIns
        run: |
          echo "ğŸ“¦ Manually copying XCTest bundle to PlugIns directory..."
          
          # Find the built app and test bundle
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          TEST_BUNDLE_PATH=$(find ./build -name "TrollTouchUITests.xctest" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ TrollTouch.app not found"
            exit 1
          fi
          
          if [ -z "$TEST_BUNDLE_PATH" ]; then
            echo "âŒ TrollTouchUITests.xctest not found"
            exit 1
          fi
          
          echo "App path: $APP_PATH"
          echo "Test bundle path: $TEST_BUNDLE_PATH"
          
          # Create PlugIns directory
          mkdir -p "$APP_PATH/PlugIns"
          
          # Copy test bundle
          cp -R "$TEST_BUNDLE_PATH" "$APP_PATH/PlugIns/"
          
          echo "âœ… XCTest bundle copied to PlugIns directory"
          ls -la "$APP_PATH/PlugIns/"

      - name: Embed XCTest.framework
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "ğŸ“¦ Embedding XCTest.framework and dependencies into app bundle..."
          
          # Create Frameworks and PrivateFrameworks directories
          mkdir -p "$APP_PATH/Frameworks"
          mkdir -p "$APP_PATH/PrivateFrameworks"
          
          # Define base path for Xcode frameworks
          XCODE_FRAMEWORKS="/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library"
          XCODE_PRIVATE_FRAMEWORKS="$XCODE_FRAMEWORKS/PrivateFrameworks"
          
          echo "ğŸ“¦ Copying all XCTest-related frameworks..."
          
          # Copy XCTest.framework (public framework)
          if [ -d "$XCODE_FRAMEWORKS/Frameworks/XCTest.framework" ]; then
            cp -R "$XCODE_FRAMEWORKS/Frameworks/XCTest.framework" "$APP_PATH/Frameworks/"
            echo "âœ… XCTest.framework copied to Frameworks"
          else
            echo "âŒ XCTest.framework not found"
            exit 1
          fi
          
          # Copy ALL frameworks from PrivateFrameworks that start with XC
          # This ensures we don't miss any dependencies
          echo "ğŸ“¦ Copying all XC* frameworks from PrivateFrameworks..."
          for framework in "$XCODE_PRIVATE_FRAMEWORKS"/XC*.framework; do
            if [ -d "$framework" ]; then
              framework_name=$(basename "$framework")
              cp -R "$framework" "$APP_PATH/PrivateFrameworks/"
              echo "âœ… $framework_name copied to PrivateFrameworks"
            fi
          done
          
          # Also copy any other test-related frameworks
          for framework_name in "DTX" "DVT" "IDE"; do
            for framework in "$XCODE_PRIVATE_FRAMEWORKS"/${framework_name}*.framework; do
              if [ -d "$framework" ]; then
                name=$(basename "$framework")
                cp -R "$framework" "$APP_PATH/PrivateFrameworks/"
                echo "âœ… $name copied to PrivateFrameworks"
              fi
            done
          done
          
          echo "ğŸ“‹ Directory contents:"
          echo "Frameworks:"
          ls -la "$APP_PATH/Frameworks/" || true
          echo "PrivateFrameworks:"
          ls -la "$APP_PATH/PrivateFrameworks/" || true
          echo "Total frameworks copied: $(ls -1 "$APP_PATH/PrivateFrameworks/" | wc -l)"
          
          # Fix rpath for UITests bundle to find frameworks
          echo "ğŸ”§ Fixing rpath for UITests bundle..."
          install_name_tool -add_rpath @executable_path/Frameworks \
            "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" 2>/dev/null || true
          
          install_name_tool -add_rpath @executable_path/../Frameworks \
            "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" 2>/dev/null || true
            
          install_name_tool -add_rpath @executable_path/../PrivateFrameworks \
            "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" 2>/dev/null || true
          
          # Fix rpath for XCTest.framework to find XCTestCore
          echo "ğŸ”§ Fixing rpath for XCTest.framework..."
          install_name_tool -add_rpath @loader_path/../PrivateFrameworks \
            "$APP_PATH/Frameworks/XCTest.framework/XCTest" 2>/dev/null || true
            
          install_name_tool -add_rpath @loader_path/. \
            "$APP_PATH/Frameworks/XCTest.framework/XCTest" 2>/dev/null || true
          
          echo "âœ… XCTest framework and dependencies embedded successfully"

      - name: Verify Build Output
        run: |
          echo "ğŸ“¦ Checking build output..."
          find ./build -name "TrollTouch.app" -type d
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "âŒ TrollTouch.app not found in build output"
            exit 1
          fi
          echo "âœ… App found at: $APP_PATH"
          
          # éªŒè¯æµ‹è¯•bundleæ˜¯å¦å­˜åœ¨
          if [ -d "$APP_PATH/PlugIns/TrollTouchUITests.xctest" ]; then
            echo "âœ… XCTest bundle found in app"
          else
            echo "âŒ XCTest bundle not found"
            exit 1
          fi
          
          # æ£€æŸ¥XCTestæ¡†æ¶é“¾æ¥
          echo "ğŸ” Checking XCTest framework linkage..."
          otool -L "$APP_PATH/PlugIns/TrollTouchUITests.xctest/TrollTouchUITests" || true

      - name: Install ldid for Signing
        run: brew install ldid

      - name: Sign Binaries with ldid
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "ğŸ” Signing binaries with ldid..."
          echo "App path: $APP_PATH"
          
          # æ˜¾ç¤ºappå†…å®¹
          echo "ğŸ“‚ App structure:"
          ls -laR "$APP_PATH"
          
          # ç­¾åä¸»åº”ç”¨å¯æ‰§è¡Œæ–‡ä»¶
          MAIN_EXEC="$APP_PATH/TrollTouch"
          if [ -f "$MAIN_EXEC" ]; then
            echo "âœ… Found main executable: $MAIN_EXEC"
            # ä½¿ç”¨ entitlements.plist è¿›è¡Œç­¾å
            ldid -S"entitlements.plist" "$MAIN_EXEC"
            echo "âœ… Signed main app with entitlements"
          else
            echo "âŒ Main executable not found: $MAIN_EXEC"
            exit 1
          fi
          
          # ç­¾åæµ‹è¯•bundle
          TEST_BUNDLE="$APP_PATH/PlugIns/TrollTouchUITests.xctest"
          if [ -d "$TEST_BUNDLE" ]; then
            echo "âœ… Found test bundle: $TEST_BUNDLE"
            echo "ğŸ“‚ Test bundle contents:"
            ls -la "$TEST_BUNDLE"
            
            TEST_EXEC="$TEST_BUNDLE/TrollTouchUITests"
            if [ -f "$TEST_EXEC" ]; then
              echo "âœ… Found test executable: $TEST_EXEC"
              # æµ‹è¯•bundleä¹Ÿå¯ä»¥ç”¨åŒæ ·çš„æƒé™ï¼Œæˆ–è€…ç®€å•çš„ä¼ªç­¾å
              ldid -S"entitlements.plist" "$TEST_EXEC"
              echo "âœ… Signed XCTest bundle"
            else
              echo "âŒ Test executable not found: $TEST_EXEC"
              echo "Available files in bundle:"
              find "$TEST_BUNDLE" -type f
              exit 1
            fi
          else
            echo "âŒ Test bundle not found: $TEST_BUNDLE"
            exit 1
          fi

      - name: Package IPA
        run: |
          APP_PATH=$(find ./build -name "TrollTouch.app" -type d | head -n 1)
          echo "ğŸ“¦ Packaging IPA..."
          
          # åˆ›å»ºPayloadç›®å½•
          mkdir -p Payload
          
          # å¤åˆ¶appåˆ°Payload
          cp -R "$APP_PATH" Payload/
          
          # ç¡®ä¿Info.plistæ­£ç¡®
          cp TrollTouch/Info.plist Payload/TrollTouch.app/Info.plist
          
          # æ‰“åŒ…ä¸ºIPA
          zip -r TrollTouch.ipa Payload
          
          echo "âœ… IPA created successfully"
          ls -lh TrollTouch.ipa

      - name: Verify IPA Contents
        run: |
          echo "ğŸ” Verifying IPA structure..."
          unzip -l TrollTouch.ipa
          
          echo ""
          echo "ğŸ“ Checking for XCTest bundle..."
          if unzip -l TrollTouch.ipa | grep -q "TrollTouchUITests.xctest"; then
            echo "âœ… XCTest bundle is included in IPA"
          else
            echo "âŒ XCTest bundle missing from IPA"
            exit 1
          fi

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TrollTouch_IPA
          path: TrollTouch.ipa
          retention-days: 30

      - name: Upload Build Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Build_Logs
          path: |
            ./build/Logs
          retention-days: 7

