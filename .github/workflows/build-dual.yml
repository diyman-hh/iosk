name: Build TrollTouch (Dual IPA)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      # ========================================
      # Build TrollTouchAgent (Agent IPA)
      # ========================================
      
      - name: Generate Agent Xcode Project
        run: |
          cd TrollTouchAgent
          xcodegen generate
          echo "âœ… Agent Xcode project generated"

      - name: Build TrollTouchAgent
        run: |
          cd TrollTouchAgent
          echo "ðŸ”¨ Building TrollTouchAgent..."
          set -o pipefail
          xcodebuild -project TrollTouchAgent.xcodeproj \
                     -scheme TrollTouchAgent \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="TrollTouchAgent/TrollTouchAgent.entitlements" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.agent \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0 \
                     2>&1 | tee build.log
          
          echo "âœ… Agent build completed"

      - name: Package Agent IPA
        run: |
          cd TrollTouchAgent
          echo "ðŸ“¦ Packaging Agent IPA..."
          
          APP_PATH="./build/Build/Products/Release-iphoneos/TrollTouchAgent.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Agent app not found at $APP_PATH"
            exit 1
          fi
          
          # Create Payload directory
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          
          # Create IPA
          zip -r TrollTouchAgent.ipa Payload
          
          echo "âœ… Agent IPA created"
          ls -lh TrollTouchAgent.ipa

      # ========================================
      # Build TrollTouch (Main IPA)
      # ========================================

      - name: Generate Main App Xcode Project
        run: |
          xcodegen generate
          echo "âœ… Main app Xcode project generated"

      - name: Build TrollTouch
        run: |
          echo "ðŸ”¨ Building TrollTouch..."
          set -o pipefail
          xcodebuild -project TrollTouch.xcodeproj \
                     -scheme TrollTouch \
                     -sdk iphoneos \
                     -configuration Release \
                     -derivedDataPath ./build \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGN_IDENTITY="" \
                     CODE_SIGN_ENTITLEMENTS="TrollTouch/TrollTouch.entitlements" \
                     PRODUCT_BUNDLE_IDENTIFIER=com.trolltouch.app \
                     IPHONEOS_DEPLOYMENT_TARGET=14.0 \
                     2>&1 | tee build.log
          
          echo "âœ… Main app build completed"

      - name: Package Main IPA
        run: |
          echo "ðŸ“¦ Packaging Main IPA..."
          
          APP_PATH="./build/Build/Products/Release-iphoneos/TrollTouch.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Main app not found at $APP_PATH"
            exit 1
          fi
          
          # Create Payload directory
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          
          # Create IPA
          zip -r TrollTouch.ipa Payload
          
          echo "âœ… Main IPA created"
          ls -lh TrollTouch.ipa

      # ========================================
      # Create Release Package
      # ========================================

      - name: Create Release Package
        run: |
          echo "ðŸ“¦ Creating release package..."
          
          mkdir -p release
          cp TrollTouchAgent/TrollTouchAgent.ipa release/
          cp TrollTouch.ipa release/
          
          # Create README
          cat > release/README.txt << 'EOF'
TrollTouch - åŒ IPA å®‰è£…åŒ…
==========================

å®‰è£…æ­¥éª¤:
1. ä½¿ç”¨ TrollStore å®‰è£… TrollTouchAgent.ipa
2. ä½¿ç”¨ TrollStore å®‰è£… TrollTouch.ipa
3. å…ˆæ‰“å¼€ TrollTouchAgent (ä¼šåœ¨åŽå°è¿è¡Œ HTTP Server)
4. ç„¶åŽæ‰“å¼€ TrollTouch (ä¸»åº”ç”¨)

æ³¨æ„:
- TrollTouchAgent å¿…é¡»ä¿æŒè¿è¡Œæ‰èƒ½è¿›è¡Œè§¦æ‘¸æ³¨å…¥
- ä¸¤ä¸ªåº”ç”¨éƒ½éœ€è¦é€šè¿‡ TrollStore å®‰è£…ä»¥èŽ·å¾—å¿…è¦æƒé™
- ç¡®ä¿è®¾å¤‡è¿è¡Œ iOS 14.0 æˆ–æ›´é«˜ç‰ˆæœ¬

ç‰ˆæœ¬: $(date +%Y%m%d-%H%M%S)
EOF
          
          # Create zip
          cd release
          zip -r ../TrollTouch-Complete-$(date +%Y%m%d-%H%M%S).zip .
          cd ..
          
          echo "âœ… Release package created"
          ls -lh TrollTouch-Complete-*.zip

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TrollTouch-IPAs
          path: |
            TrollTouch-Complete-*.zip
            release/TrollTouchAgent.ipa
            release/TrollTouch.ipa
            release/README.txt

      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "- TrollTouchAgent.ipa (Agent - è§¦æ‘¸æ³¨å…¥æœåŠ¡)" >> $GITHUB_STEP_SUMMARY
          echo "- TrollTouch.ipa (Main App - ç”¨æˆ·ç•Œé¢)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download:" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Artifacts' section above to download the complete package." >> $GITHUB_STEP_SUMMARY
